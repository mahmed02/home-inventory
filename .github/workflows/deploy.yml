name: Deploy API

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      action:
        description: "deploy or rollback"
        required: true
        default: deploy
        type: choice
        options:
          - deploy
          - rollback
      environment:
        description: "Target environment"
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production
      ref:
        description: "Git ref/sha (required for rollback; optional for deploy)"
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy via SSM
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'staging' }}
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      EC2_INSTANCE_ID: ${{ vars.EC2_INSTANCE_ID }}
      APP_DIR: ${{ vars.APP_DIR != '' && vars.APP_DIR || '/srv/home_inventory' }}
      PROCESS_NAME: ${{ vars.PROCESS_NAME != '' && vars.PROCESS_NAME || 'home-inventory-api' }}
      DEPLOY_USER: ${{ vars.DEPLOY_USER != '' && vars.DEPLOY_USER || 'ubuntu' }}
      DEPLOY_HEALTH_MAX_ATTEMPTS: ${{ vars.DEPLOY_HEALTH_MAX_ATTEMPTS != '' && vars.DEPLOY_HEALTH_MAX_ATTEMPTS || '' }}
      DEPLOY_HEALTH_RETRY_DELAY_SECONDS: ${{ vars.DEPLOY_HEALTH_RETRY_DELAY_SECONDS != '' && vars.DEPLOY_HEALTH_RETRY_DELAY_SECONDS || '' }}
      DISPATCH_ACTION: ${{ github.event_name == 'workflow_dispatch' && inputs.action || 'deploy' }}
      DISPATCH_REF: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
      DEFAULT_DEPLOY_REF: ${{ github.sha }}
    steps:
      - name: Validate required config
        run: |
          set -euo pipefail
          if [[ -z "${AWS_REGION}" ]]; then
            echo "Missing environment variable: AWS_REGION" >&2
            exit 1
          fi
          if [[ -z "${EC2_INSTANCE_ID}" ]]; then
            echo "Missing environment variable: EC2_INSTANCE_ID" >&2
            exit 1
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Send SSM command
        id: send
        run: |
          set -euo pipefail

          validate_ref() {
            local ref_value="$1"
            if [[ -z "${ref_value}" ]]; then
              echo "ref cannot be empty" >&2
              exit 1
            fi
            if [[ "${ref_value}" == -* ]]; then
              echo "ref cannot start with '-'" >&2
              exit 1
            fi
            if [[ ! "${ref_value}" =~ ^[A-Za-z0-9._/-]+$ ]]; then
              echo "ref contains invalid characters" >&2
              exit 1
            fi
          }

          validate_app_dir() {
            local app_dir_value="$1"
            if [[ -z "${app_dir_value}" ]]; then
              echo "APP_DIR cannot be empty" >&2
              exit 1
            fi
            if [[ "${app_dir_value}" != /* ]]; then
              echo "APP_DIR must be an absolute path" >&2
              exit 1
            fi
            if [[ "${app_dir_value}" == -* ]]; then
              echo "APP_DIR cannot start with '-'" >&2
              exit 1
            fi
            if [[ "${app_dir_value}" == *".."* ]]; then
              echo "APP_DIR cannot contain '..'" >&2
              exit 1
            fi
            if [[ ! "${app_dir_value}" =~ ^[A-Za-z0-9._/-]+$ ]]; then
              echo "APP_DIR contains invalid characters" >&2
              exit 1
            fi
          }

          validate_process_name() {
            local process_name_value="$1"
            if [[ -z "${process_name_value}" ]]; then
              echo "PROCESS_NAME cannot be empty" >&2
              exit 1
            fi
            if [[ "${process_name_value}" == -* ]]; then
              echo "PROCESS_NAME cannot start with '-'" >&2
              exit 1
            fi
            if [[ ! "${process_name_value}" =~ ^[A-Za-z0-9._:-]+$ ]]; then
              echo "PROCESS_NAME contains invalid characters" >&2
              exit 1
            fi
          }

          validate_deploy_user() {
            local deploy_user_value="$1"
            if [[ -z "${deploy_user_value}" ]]; then
              echo "DEPLOY_USER cannot be empty" >&2
              exit 1
            fi
            if [[ ! "${deploy_user_value}" =~ ^[A-Za-z_][A-Za-z0-9_-]*$ ]]; then
              echo "DEPLOY_USER contains invalid characters" >&2
              exit 1
            fi
          }

          validate_positive_int() {
            local value="$1"
            local label="$2"
            if [[ ! "${value}" =~ ^[0-9]+$ ]]; then
              echo "${label} must be a positive integer" >&2
              exit 1
            fi
            if (( value < 1 )); then
              echo "${label} must be at least 1" >&2
              exit 1
            fi
          }

          if [[ "${DISPATCH_ACTION}" != "deploy" && "${DISPATCH_ACTION}" != "rollback" ]]; then
            echo "Unsupported action: ${DISPATCH_ACTION}" >&2
            exit 1
          fi

          validate_app_dir "${APP_DIR}"
          validate_process_name "${PROCESS_NAME}"
          validate_deploy_user "${DEPLOY_USER}"

          if [[ -n "${DEPLOY_HEALTH_MAX_ATTEMPTS}" ]]; then
            validate_positive_int "${DEPLOY_HEALTH_MAX_ATTEMPTS}" "DEPLOY_HEALTH_MAX_ATTEMPTS"
          fi
          if [[ -n "${DEPLOY_HEALTH_RETRY_DELAY_SECONDS}" ]]; then
            validate_positive_int "${DEPLOY_HEALTH_RETRY_DELAY_SECONDS}" "DEPLOY_HEALTH_RETRY_DELAY_SECONDS"
          fi

          REMOTE_BASE="cd ${APP_DIR} && git -c safe.directory=${APP_DIR} stash push --include-untracked --message workflow-predeploy-${GITHUB_RUN_ID} >/dev/null || true && chmod +x scripts/deploy.sh scripts/rollback.sh"

          if [[ "${DISPATCH_ACTION}" == "rollback" ]]; then
            if [[ -z "${DISPATCH_REF}" ]]; then
              echo "Rollback requires workflow input: ref" >&2
              exit 1
            fi
            validate_ref "${DISPATCH_REF}"
            REMOTE_CMD="${REMOTE_BASE} && APP_DIR=${APP_DIR} ROLLBACK_REF=${DISPATCH_REF} ./scripts/rollback.sh"
          else
            DEPLOY_REF="${DISPATCH_REF:-${DEFAULT_DEPLOY_REF}}"
            validate_ref "${DEPLOY_REF}"
            DEPLOY_OVERRIDES=""
            if [[ -n "${DEPLOY_HEALTH_MAX_ATTEMPTS}" ]]; then
              DEPLOY_OVERRIDES="${DEPLOY_OVERRIDES} DEPLOY_HEALTH_MAX_ATTEMPTS=${DEPLOY_HEALTH_MAX_ATTEMPTS}"
            fi
            if [[ -n "${DEPLOY_HEALTH_RETRY_DELAY_SECONDS}" ]]; then
              DEPLOY_OVERRIDES="${DEPLOY_OVERRIDES} DEPLOY_HEALTH_RETRY_DELAY_SECONDS=${DEPLOY_HEALTH_RETRY_DELAY_SECONDS}"
            fi
            REMOTE_CMD="${REMOTE_BASE} && APP_DIR=${APP_DIR} DEPLOY_REF=${DEPLOY_REF} PROCESS_NAME=${PROCESS_NAME}${DEPLOY_OVERRIDES} ./scripts/deploy.sh"
          fi

          printf -v COMMAND "sudo -u %s -H bash -lc %q" "${DEPLOY_USER}" "${REMOTE_CMD}"
          PARAMETERS_JSON=$(jq -cn --arg cmd "${COMMAND}" '{commands: [$cmd]}')

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${EC2_INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --comment "home_inventory ${DISPATCH_ACTION} ${GITHUB_RUN_ID}" \
            --parameters "${PARAMETERS_JSON}" \
            --query 'Command.CommandId' \
            --output text)

          echo "command_id=${COMMAND_ID}" >> "$GITHUB_OUTPUT"
          echo "Sent command: ${COMMAND_ID}"

      - name: Wait for SSM completion
        run: |
          set -euo pipefail
          COMMAND_ID="${{ steps.send.outputs.command_id }}"

          while true; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${EC2_INSTANCE_ID}" \
              --query 'Status' \
              --output text)

            echo "Current status: ${STATUS}"

            case "${STATUS}" in
              Success)
                break
                ;;
              Failed|Cancelled|TimedOut|Undeliverable|Terminated)
                aws ssm get-command-invocation \
                  --command-id "${COMMAND_ID}" \
                  --instance-id "${EC2_INSTANCE_ID}" \
                  --query '{Status:Status,StandardOutputContent:StandardOutputContent,StandardErrorContent:StandardErrorContent}' \
                  --output json
                exit 1
                ;;
            esac

            sleep 10
          done

      - name: Print command output
        run: |
          set -euo pipefail
          aws ssm get-command-invocation \
            --command-id "${{ steps.send.outputs.command_id }}" \
            --instance-id "${EC2_INSTANCE_ID}" \
            --query '{Status:Status,StandardOutputContent:StandardOutputContent,StandardErrorContent:StandardErrorContent}' \
            --output json
