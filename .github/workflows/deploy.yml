name: Deploy API

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      action:
        description: "deploy or rollback"
        required: true
        default: deploy
        type: choice
        options:
          - deploy
          - rollback
      environment:
        description: "Target environment"
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production
      ref:
        description: "Git ref/sha (required for rollback; optional for deploy)"
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy via SSM
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'staging' }}
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      EC2_INSTANCE_ID: ${{ vars.EC2_INSTANCE_ID }}
      APP_DIR: ${{ vars.APP_DIR != '' && vars.APP_DIR || '/srv/home_inventory' }}
      PROCESS_NAME: ${{ vars.PROCESS_NAME != '' && vars.PROCESS_NAME || 'home-inventory-api' }}
      DISPATCH_ACTION: ${{ github.event_name == 'workflow_dispatch' && inputs.action || 'deploy' }}
      DISPATCH_REF: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
      DEFAULT_DEPLOY_REF: ${{ github.sha }}
    steps:
      - name: Validate required config
        run: |
          set -euo pipefail
          if [[ -z "${AWS_REGION}" ]]; then
            echo "Missing environment variable: AWS_REGION" >&2
            exit 1
          fi
          if [[ -z "${EC2_INSTANCE_ID}" ]]; then
            echo "Missing environment variable: EC2_INSTANCE_ID" >&2
            exit 1
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Send SSM command
        id: send
        run: |
          set -euo pipefail

          if [[ "${DISPATCH_ACTION}" == "rollback" ]]; then
            if [[ -z "${DISPATCH_REF}" ]]; then
              echo "Rollback requires workflow input: ref" >&2
              exit 1
            fi
            COMMAND="git config --global --add safe.directory ${APP_DIR} && cd ${APP_DIR} && git fetch --all --prune && git checkout ${DISPATCH_REF} && chmod +x scripts/deploy.sh scripts/rollback.sh && APP_DIR=${APP_DIR} ROLLBACK_REF=${DISPATCH_REF} ./scripts/rollback.sh"
          else
            DEPLOY_REF="${DISPATCH_REF:-${DEFAULT_DEPLOY_REF}}"
            COMMAND="git config --global --add safe.directory ${APP_DIR} && cd ${APP_DIR} && git fetch --all --prune && git checkout ${DEPLOY_REF} && chmod +x scripts/deploy.sh scripts/rollback.sh && APP_DIR=${APP_DIR} DEPLOY_REF=${DEPLOY_REF} PROCESS_NAME=${PROCESS_NAME} ./scripts/deploy.sh"
          fi

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${EC2_INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --comment "home_inventory ${DISPATCH_ACTION} ${GITHUB_RUN_ID}" \
            --parameters commands="${COMMAND}" \
            --query 'Command.CommandId' \
            --output text)

          echo "command_id=${COMMAND_ID}" >> "$GITHUB_OUTPUT"
          echo "Sent command: ${COMMAND_ID}"

      - name: Wait for SSM completion
        run: |
          set -euo pipefail
          COMMAND_ID="${{ steps.send.outputs.command_id }}"

          while true; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${EC2_INSTANCE_ID}" \
              --query 'Status' \
              --output text)

            echo "Current status: ${STATUS}"

            case "${STATUS}" in
              Success)
                break
                ;;
              Failed|Cancelled|TimedOut|Undeliverable|Terminated)
                aws ssm get-command-invocation \
                  --command-id "${COMMAND_ID}" \
                  --instance-id "${EC2_INSTANCE_ID}" \
                  --query '{Status:Status,StandardOutputContent:StandardOutputContent,StandardErrorContent:StandardErrorContent}' \
                  --output json
                exit 1
                ;;
            esac

            sleep 10
          done

      - name: Print command output
        run: |
          set -euo pipefail
          aws ssm get-command-invocation \
            --command-id "${{ steps.send.outputs.command_id }}" \
            --instance-id "${EC2_INSTANCE_ID}" \
            --query '{Status:Status,StandardOutputContent:StandardOutputContent,StandardErrorContent:StandardErrorContent}' \
            --output json
